<?xml version="1.0" ?>
<project>

  <target name="exec-ext">
    <condition property="ext" value=".sh">
      <os family="unix"/>
    </condition>
    <condition property="ext" value=".bat">
      <os family="windows"/>
    </condition>
    <property name="ext" value=""/>
  </target>

  <target name="fedora-install" depends="exec-ext">
    <property name="FEDORA_JAR"
      value="${localRepository}/${fedora-groupId}/${fedora-artifactId}/${fedora-version}/${fedora-artifactId}-${fedora-version}.jar"/> 

    <property name="FEDORA_HOME"
      value="${FEDORA_INSTALL_DIR}/fedora-${fedora-version}"/>

    <mkdir dir="${FEDORA_INSTALL_DIR}"/>
    <unjar src="${FEDORA_JAR}" dest="${FEDORA_INSTALL_DIR}"/>
    <chmod perm="u+x">
      <fileset dir="${FEDORA_HOME}">
        <include name="**/bin/*"/>
      </fileset>
    </chmod>
    <exec dir="${FEDORA_HOME}"
      executable="${FEDORA_HOME}/server/bin/mckoi-init${ext}">
      <arg line="fedoraAdmin fedoraAdmin"/>
      <env key="FEDORA_HOME" file="${FEDORA_HOME}"/>
    </exec>
  </target>

  <target name="fedora-start" depends="exec-ext">
    <echo>Starting mckoi: FEDORA_HOME = ${FEDORA_HOME}</echo>
    <exec dir="${FEDORA_HOME}" 
      executable="${FEDORA_HOME}/server/bin/mckoi-start${ext}"
      spawn="true">
      <env key="FEDORA_HOME" file="${FEDORA_HOME}"/>
    </exec>

    <echo>Spawned off mckoi</echo>
    <!-- <sleep seconds="2"/> -->
  
    <echo>Starting fedora: FEDORA_HOME = ${FEDORA_HOME}</echo>
    <echo>You can safely hit Ctl-C to kill the mvn command</echo>
    <exec dir="${FEDORA_HOME}"
      executable="${FEDORA_HOME}/server/bin/fedora-start${ext}"
      spawn="false">
      <arg line="mckoi"/>
      <env key="FEDORA_HOME" file="${FEDORA_HOME}"/>
    </exec>
  </target>

  <target name="fedora-stop" depends="exec-ext">
    <echo>Stopping fedora: FEDORA_HOME = ${FEDORA_HOME}</echo>
    <exec dir="${FEDORA_HOME}" 
      executable="${FEDORA_HOME}/server/bin/fedora-stop${ext}">
      <env key="FEDORA_HOME" file="${FEDORA_HOME}"/>
    </exec>
    <echo>Stopping mckoi: FEDORA_HOME = ${FEDORA_HOME}</echo>
    <exec dir="${FEDORA_HOME}"
      executable="${FEDORA_HOME}/server/bin/mckoi-stop${ext}">
      <arg line="fedoraAdmin fedoraAdmin"/>
      <env key="FEDORA_HOME" file="${FEDORA_HOME}"/>
    </exec>
  </target>

  <target name="fedora-package" depends="exec-ext">
    <!-- untar fedora server distribution -->
    <untar
      src="${LOCAL_REPOSITORY}/info/fedora/server/${VERSION}/server-${VERSION}.tar"
      dest="${BUILD_DIRECTORY}/${FINAL_NAME}">
    </untar>

    <!-- untar fedora client distribution -->
    <untar
      src="${LOCAL_REPOSITORY}/info/fedora/client/${VERSION}/client-${VERSION}.tar"
      dest="${BUILD_DIRECTORY}/${FINAL_NAME}">
    </untar>

    <!-- setup execute permissions for bin/* -->
    <chmod perm="u+x">
      <fileset
        dir="${BUILD_DIRECTORY}/${FINAL_NAME}">
        <include name="**/bin/*"/>
      </fileset>
    </chmod>

    <!-- execute fedora-setup with no-ssl-authenticate-apim -->
    <exec
      dir="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}"
      executable="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}/server/bin/fedora-setup${ext}">
      <arg line="no-ssl-authenticate-apim"/>
      <env key="FEDORA_HOME"
        file="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}"/>
    </exec>

    <!-- configure fedora (overwrite with our local copy) -->
    <copy file="server/fedora.fcfg"
      tofile="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}/server/config/fedora.fcfg/"
      overwrite="true"/>

    <!-- unzip the diringest service -->
    <unzip
      src="${LOCAL_REPOSITORY}/info/fedora/diringest/${VERSION}/diringest-${VERSION}.zip"
      dest="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}">
    </unzip>

    <!-- unwar the diringest war file -->
    <unwar
      src="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}/diringest-service/diringest.war"
      dest="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}/server/${TOMCAT}/webapps/diringest/">
    </unwar>

    <!-- configure diringest (overwrite with our local copy) -->
    <copy file="diringest/diringest.properties"
      tofile="${BUILD_DIRECTORY}/${FINAL_NAME}/fedora-${VERSION}/server/${TOMCAT}/webapps/diringest/WEB-INF/classes/diringest.properties"
      overwrite="true"/>

    <!-- jar everything up and overwrite the package target created by maven -->
    <jar
      destfile="${BUILD_DIRECTORY}/${FINAL_NAME}.jar"
      basedir="${BUILD_DIRECTORY}/${FINAL_NAME}"/>
  </target>
</project>
