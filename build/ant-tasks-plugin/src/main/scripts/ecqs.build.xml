<?xml version="1.0" encoding="UTF-8"?>
<!--
  $HeadURL::                                                                             $
  $Id$

  Copyright (c) 2006 by Topaz, Inc.
  http://topazproject.org

  Licensed under the Educational Community License version 1.0
  http://opensource.org/licenses/ecl1.php
-->
<project xmlns:artifact="antlib:org.apache.maven.artifact.ant">

  <!-- Define dependencies needed if we want to use <classpath refid="dependency.classpath" />
       in a <java /> task. See antlib: http://maven.apache.org/ant-tasks.html -->
  <artifact:dependencies pathId="dependency.classpath"
      xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <dependency groupId="ant" artifactId="ant" version="1.6.5"/>
    <dependency groupId="ant" artifactId="ant-launcher" version="1.6.5"/>
  </artifact:dependencies>
  
  <target name="exec-ext">
    <condition property="ext" value="">
      <os family="unix"/>
    </condition>
    <condition property="ext" value=".bat">
      <os family="windows"/>
    </condition>
    <property name="ext" value=""/>
  </target>

  <target name="patch-keytool">
    <condition property="patch-keytool-string"
     value="jakarta-tomcat.keytool.path=${env.JAVA_HOME}/bin/keytool">
       <os family="unix"/>
    </condition>
    <property name="patch-keytool-string" value=""/>
  </target>

	<!--
  <artifact:dependencies pathId="cas-mod.dependencies"
      xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <dependency groupId="org.plosone" artifactId="plosone-cas-mod" version="0.5-SNAPSHOT"/>
  </artifact:dependencies>
-->
	
  <target name="ecqs-package" depends="patch-keytool">
    <!-- unzip the package -->
    <unzip src="${SRC_ZIP}" dest="${DEST_DIR}"/>
  	
  	<!-- needed for cas-mod -->
    <copy file="build-esup-cas-server.xml" 
    			todir="${DEST_DIR}/${ROOT}"
    			overwrite="true"
    />

		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${CAS_MOD}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${PASSWORD_MOD}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${DATABASE_DRIVER}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${COMMONS_LOGGING}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${COMMONS_DBCP}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${COMMONS_POOL}"/>
		<copy todir="${DEST_DIR}/${ROOT}/${CAS_SERVER_LIB_PATH}" file="${COMMONS_COLLECTIONS}"/>
  	<!-- end cas-mod -->
    
    <!-- configure it -->
    <copy file="properties/build.properties"
      tofile="${DEST_DIR}/${ROOT}/properties/build.properties"
      overwrite="true"/>
    <echo file="${DEST_DIR}/${ROOT}/properties/build.properties"
      append="yes" message="${patch-keytool-string}"/>
    <copy todir="${DEST_DIR}/${ROOT}/custom">
      <fileset dir="custom"/>
    </copy>
  	
    <!-- jar it up -->
    <jar destfile="${DEST_DIR}.jar" basedir="${DEST_DIR}"/>
  </target>
	
  <target name="ecqs-install" depends="exec-ext">
    <unjar src="${SRC_JAR}" dest="${DEST_DIR}"/>
    <!--
     Bloody maven; javac task won't execute 
     <ant dir="${DEST_DIR}/${ROOT}" target="install"/> 
     -->
    <exec dir="${DEST_DIR}/${ROOT}" executable="ant${ext}">
      <arg line="install"/>
    </exec>
  </target>

  <target name="ecqs-uninstall">
    <delete dir="${DEST_DIR}/${ROOT}"/>
  </target>

  <!-- Runs ecqs-install IF the INSTALL propery/config is set - used by ecqs-start -->
  <target name="ecqs-install-if" if="INSTALL" depends="exec-ext">
    <echo>Installing ECQS</echo>
    <!-- Stupid maven-plugin-plugin/maven-plugin-tools-ant - won't let us use <antcall /> -->
    <exec executable="mvn${ext}">
      <arg line="ant-tasks:ecqs-install"/>
    </exec>
  </target>
  
  <target name="ecqs-start" depends="ecqs-install-if">
    <echo>Starting CAS (spawn=${SPAWN})</echo>
    <java classname="org.apache.tools.ant.Main"
          dir="${DEST_DIR}/${ROOT}"
          fork="true" spawn="${SPAWN}">
      <classpath refid="dependency.classpath" />
      <arg line="-f ${DEST_DIR}/${ROOT}/build.xml tomcat-start"/>
    </java>
  </target>

  <target name="ecqs-stop" depends="exec-ext">
    <exec dir="${DEST_DIR}/${ROOT}" executable="ant${ext}">
      <arg line="tomcat-stop"/>
    </exec>
  </target>
    
</project>
