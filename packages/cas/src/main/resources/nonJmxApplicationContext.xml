<?xml version="1.0" encoding="UTF-8"?>
<beans default-autowire="autodetect"
       xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

  <!--Plosone developer beans here -->
  <bean id="serviceFactory" class="org.plos.service.ServiceFactory">
    <property name="persistenceService" ref="persistenceService"/>
    <property name="registrationService" ref="registrationService"/>
  </bean>

  <bean id="persistenceService" class="org.plos.service.impl.PlosPersistenceService">
    <property name="userDAO" ref="userDAO"/>
  </bean>

  <bean id="userDAO" class="org.plos.service.impl.HibernateUserDAO">
    <property name="sessionFactory">
      <ref bean="registrationSessionFactory"/>
    </property>
  </bean>

  <bean id="defaultEncodingCharset" class="java.lang.String">
    <constructor-arg value="UTF-8"/>
  </bean>

  <bean id="registrationService" class="org.plos.service.impl.PlosRegistrationService" scope="session">
    <!-- proxy needed as this bean is a part of a singleton's reference  -->
    <aop:scoped-proxy/>
    <property name="userDAO" ref="userDAO"/>
    <property name="passwordDigestService" ref="plosPasswordDigestService"/>
    <property name="mailer" ref="registrationVerificationMailer"/>
  </bean>

  <!-- required for email -->
  <bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
    <property name="host" value="localhost"/>
  </bean>

<!--
  <bean id="mailSession" class="org.springframework.jndi.JndiObjectFactoryBean">
    <property name="jndiName">
      <value>java:comp/env/mail/Session</value>
    </property>
  </bean>

  <bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
    <property name="session">
      <ref bean="mailSession"/>
    </property>
  </bean>
-->

  <bean id="freemarkerConfig" class="org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer">
  <!--<bean id="freemarkerConfig" class="org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean">-->
    <property name="templateLoaderPath" value="/WEB-INF/emailTemplates/"/>
    <property name="defaultEncoding" ref="defaultEncodingCharset"/>
  </bean>

  <bean id="registrationVerificationMailer" class="org.plos.service.RegistrationMailer">
    <property name="mailSender" ref="mailSender"/>
    <property name="fromEmailAddress" value="registration@plosone.org"/>
    <property name="fromEmailName" value="PLoS Registration"/>
    <property name="freeMarkerConfigurer" ref="freemarkerConfig"/>
    <property name="verifyEmailMap">
      <map>
        <entry key="text" value="verifyEmail-text.ftl"/>
        <entry key="html" value="verifyEmail-html.ftl"/>
        <entry key="url" value="https://FQHN:7443/plos-registration/emailVerification.action"/>
        <entry key="subject" value="Please verify your PLoS registration"/>
      </map>
    </property>
    <property name="forgotPasswordVerificationEmailMap">
      <map>
        <entry key="text" value="forgotPasswordVerificationEmailTemplate-text.ftl"/>
        <entry key="html" value="forgotPasswordVerificationEmailTemplate-html.ftl"/>
        <entry key="url" value="https://FQHN:7443/plos-registration/forgotPasswordVerify.action"/>
        <entry key="subject" value="PLoS Password Reset Request"/>
      </map>
    </property>
  </bean>

  <bean id="plosPasswordDigestService" class="org.plos.service.password.PasswordDigestService">
    <property name="algorithm" value="SHA-256"/>
    <property name="encodingCharset" ref="defaultEncodingCharset"/>
  </bean>

  <!--Beans from Spring distribution  -->

  <!-- Postgres datasource -->
  <bean id="registrationDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="org.postgresql.Driver"/>
    <property name="url" value="jdbc:postgresql://localhost/plosdb"/>
    <property name="username" value="plosone"/>
    <property name="password" value="loot2_debonAir"/>
  </bean>

  <!-- Useful link:
  http://static.springframework.org/spring/docs/2.0.x/api/org/springframework/orm/hibernate3/annotation/AnnotationSessionFactoryBean.html -->
  <!--  Injection for hibernate SessionFactory -->
  <bean id="registrationSessionFactory" class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean">
    <property name="dataSource" ref="registrationDataSource"/>
    <property name="annotatedClasses">
      <list>
        <value>org.plos.registration.UserImpl</value>
      </list>
    </property>
    <property name="hibernateProperties">
      <props>
        <prop key="hibernate.dialect">org.hibernate.dialect.PostgreSQLDialect</prop>
        <prop key="hibernate.hbm2ddl.auto">update</prop>
        <prop key="hibernate.show_sql">true</prop>
      </props>
    </property>
  </bean>


  <!--  Transaction injection for annotated transaction classes-->
  <bean id="registrationTxManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
    <property name="sessionFactory" ref="registrationSessionFactory"/>
  </bean>

  <bean class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"/>

  <bean class="org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor">
    <property name="transactionInterceptor" ref="transactionInterceptor"/>
  </bean>

  <bean id="transactionInterceptor" class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <property name="transactionManager" ref="registrationTxManager"/>
    <property name="transactionAttributeSource">
      <bean class="org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"/>
    </property>
  </bean>
<!--  END - Transaction injection for annotated transaction classes-->

  <!-- Add all your constants to the map with a key and a value/ref -->
  <bean id="otherConstants" class="org.plos.OtherConstants">
    <property name="allConstants">
      <map>
        <entry key="mainAppUrl" value="plosone-webapp"/>
      </map>
    </property>
  </bean>

</beans>
